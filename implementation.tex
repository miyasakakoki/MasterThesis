\section{機器監視サービスの構成}
%（どのような要素で構成されているのか、また、それぞれの役割は何なのか）
%1.1全体構成（どのような要素で構成され、また、それぞれの役割について簡潔に述べる）
第3章にて述べた要件に基づき、システムを構築した。
システムは、エージェントプログラム、状態蓄積システム、状態表示システムから成り立っている。

エージェントプログラムとは、IoT機器上で動作するプログラムである。
定期的に自身の状態を検知し、状態蓄積システムへ送信する役割を果たす。
定期的かつ自発的に状態を送信することで、ネットワーク環境によらない機器の監視を可能にした。

状態蓄積システムとは、機器監視サーバー上で動作するシステムである。
エージェントプログラムから送られた状態を時刻と共に整理し、記録する。

状態表示システムとは、機器監視サーバー上で動作し、ブラウザを通しユーザーへ情報を提供する。
機器監視サーバー上で動作するプログラムと、ブラウザ側で動作するプログラム、各種データベースに別れる。

各要素が連携することで、機器の監視を容易なものとした。

\subsection{エージェントプログラム}
%（エージェントプログラムとは何なのか）
エージェントプログラムとは、IoT機器上にインストールされるプログラムである。
エージェントプログラムの役割は、自身の状態を検知・記録し、状態蓄積システムへ送信することである。
自発的に状態を報告するため、IoT機器にプライベートアドレスが付与されていても、状態を検知することができる。
また、HTTPを用いるため、間のネットワークにてブロックされることがない。

\subsection{状態蓄積システム}
%（とは何なのか）
状態蓄積システムとは、サーバー上で動作するプログラムである。
各IoT機器から送られてきた状態を時間と共に記録する役割を持つ。
状態の蓄積の為に、データベースを用いている。
次の状態表示システムとデータベースを介し連携している。

\subsection{状態表示システム}
状態表示システムとは、Webアプリケーションである。
機器情報データベース、機器状態データベース、Webサーバーアプリケーション、Webクライアントアプリケーションの4つに分けることができる。

機器情報データベースとは、機器名や機器の詳細、機器IDを管理するデータベースである。
機器状態データベースとは、機器の状態を時刻と共に記録するためのデータベースである。
Webサーバーアプリケーションは、URLに基づき機器の現在の状態や機器の過去の状態、Webページ、WebクライアントアプリケーションをWebブラウザに返すものである。
これら３つは、機器監視サーバー上で動作する。

Webクライアントアプリケーションとは、ユーザーへインターフェースを提供するものである。
Webサーバーアプリケーションに機器の現在の状態や、機器情報等を問い合わせ、必要に応じてユーザーへ表示する

\section{エージェントプログラムの実装}
エージェントプログラムの役割は、定期的にIoT機器の状態を検知し、IoT機器監視サーバーに送信することである。
どのようなLinux環境でも動作することを考え、Shellスクリプトにて実装した。

\section{状態蓄積システムの実装}
情報蓄積システムの役割は、各IoT機器上で動作するエージェントプログラムから送られてきたIoT機器の状態を時刻と共に記録することである。
api.pyというPythonスクリプトである。FalconというRESTAPIの作成に特化したライブラリを用いて実装した。

\section{機器情報データベース}
機器情報データベースの役割は、機器の名前、機器の詳細説明、機器ID、ログイン用ユーザーIDとパスワードを記録し保持する事である。
機器情報データベースには、次のようなテーブルが用意されている。
\subsection{機器情報テーブル}
機器ID、ユーザーIDをキーとして、機器の名前、機器の詳細説明を記録し保持するテーブルである。
\subsection{ユーザーテーブル}
ユーザーIDをキーとして、ユーザー名とパスワードを記録し保持するテーブルである。
機器情報データベースには、SQLiteを用いた。

\section{機器状態データベース}
機器状態データベースの役割は、機器の状態を時刻と共に記録・保持することである。
機器状態データベースには、Influxdbを用いた。
機器IDをメトリクス名（テーブル名）とし、時刻をキーとして、機器の状態を記録している。

\section{Webサーバーアプリケーション}
Webサーバーアプリケーションの役割は、与えられたHTTPリクエストを元に、各種情報を返却することにある。
Flaskと呼ばれるWebアプリケーションフレームワークを用いた。Pythonを使用している。
URLの設計として次のようになっている。
%URLと各種機能の詳細をあとで書く

\section{Webクライアントアプリケーション}
Webクライアントアプリケーションの役割は、インタラクティブなUIを提供することである。
Bootstrap,JQueryといったライブラリを用いて作成した。HTML,CSS,Javascriptで書かれている。
Javascriptで定期的に状態を取得し、HTML,CSSにて表示する。




