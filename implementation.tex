実験から抽出した要件に基づいて、システムを作成した。
要件は以下のとおりである
\begin{itemize}
	\item IoT機器の稼動状態が確認できる\\
		機器の状態については、機器が稼働していない・機器が稼働している・機器が稼働しているがネットワークに繋がっていないの３つ。
	\item IoT機器の稼動状態の記録を閲覧することができる\\
		IoT機器の稼動状態の記録が時系列に整理され、確認できることが必要である。
	\item IoT機器の停止、再起動を行うことができる\\
		回収に備えて、機器の停止、再起動を行う事ができると良い。
\end{itemize}

\section{想定するユーザーの定義}
ユーザーは、IoTサービスを構築しようとしているSIさんと定義する。

\section{システムの構成}
システムの構成は以下のとおりである。
本システムは、エージェント、サーバーの２つの要素で成り立っている。
エージェントはIoTデバイスにインストールされ、サーバーに対し定期的に通知を送る。
また、サーバーは、エージェントからの通知を記録する。
サーバーはユーザーへのインターフェースも提供しており、ユーザーはブラウザを使用して本システムを利用する。

\begin{itemize}
	\item エージェントについて
		\begin{itemize}
			\item インストールされる機器\\
				RaspberryPi(Raspbian jessie)・Intel Edison(yocto linux)にインストールされる。
			\item 機能\\
				システムに対し、現在の状態を定期的に通知する。
			\item 構成要素\\
				シェルスクリプト一つ（agent.sh)
		\end{itemize}
	\item サーバーについて
		\begin{itemize}
			\item 環境\\
				Ubuntu16.04 (xenial)
			\item インストールしたもの\\
				Python3 Influxdb
			\item 構成要素とその説明
				\begin{itemize}
					\item APIサーバ
						\begin{itemize}
							\item 使用したライブラリ\\
								Falcon
							\item 機能\\
								エージェントから送られてきたデータを展開しログ用データベースに格納する。
							\item ソースコード\\
								%あとでURL書く
						\end{itemize}
					\item ログ用データベース
						\begin{itemize}
							\item 使用したもの\\
								Influxdb
							\item 機能と説明\\
								ログを蓄積する。
								他にもデータベースとしての選択肢があったが、時系列に整理され、検索が早いらしいことから採用した。
						\end{itemize}
					\item デバイス情報用データベース
						\begin{itemize}
							\item 使用したもの\\
								sqlite3
							\item 機能と説明\\
								デバイスに関する情報を記録する。
								Pythonから使いやすかったので採用した。
						\end{itemize}
					\item Webアプリケーション
						\begin{itemize}
							\item 使用したライブラリ\\
								Flask Bootstrap JQuery
							\item 機能\\
								ユーザーからの操作を受け付け、データベースに反映する。
								また、必要な情報をデータベースから取得し表示する。
							\item ソースコード\\
						\end{itemize}
				\end{itemize}
		\end{itemize}
\end{itemize}
\section{構成部品のそれぞれの動き}

\subsection{監視エージェントの動き}
監視対象となるIoT機器には、開発した監視エージェントが入っているものとし、起動時に自動でエージェントプログラムを起動するよう設定されているものとする。
ログファイルの中には、過去のシーケンス番号が入っている。
監視エージェントは、起動後、ログファイルがあるか確認し、あった場合、ログファイルから過去のシーケンス番号を読み出す。
無かった場合、過去のシーケンス番号を0にする。
その後、現在のシーケンス番号を0にする。
監視エージェントは、監視サービスに対し過去のシーケンス番号と現在のシーケンス番号、自身が現在正常である旨のメッセージを送信する。
監視サービスから返答があった場合、受理されたとみなし、現在のシーケンス番号を0にする。
その後、過去のシーケンス番号とログファイルを削除する。
また、返答に停止・再起動のコマンドが含まれていた場合、そのコマンドを実行し終了する。
返答が無かった場合、ネットワークに障害があったとみなし、シーケンス番号をインクリメントし、ログファイルに保存する。
この動きを約1分ごとに繰り返す。

\subsection{サービスの動き}
\subsubsection{監視エージェントからメッセージを受け取った時の動き}
監視エージェントからメッセージを受け取った場合、
DBの末尾がコマンドを示すものであった場合、そのコマンドを変数に記録しておく。
過去のシーケンス番号の数だけ、接続されていなかった旨を、最後に通信があった時刻からDBに格納し、
現在のシーケンス番号の数だけ、接続されていなかった旨を、現在の時刻からさかのぼってDBに格納する。
また、現在の時刻にて機器の状態が正常であった旨をDBに格納する。
最後に、コマンドが格納されている変数の内容と、受理した旨のメッセージを監視エージェントに対し送信する。

\subsubsection{ブラウザから入力を受けた場合の動き}
まず、クッキーからセッションを読みだし、ログインしていないユーザーであった場合、ログインページヘと誘導する。
\begin{itemize}
	\item 現在の機器の状態の確認を求められた場合\\
		サービスは、DBから、機器の現在の状態とその他の機器情報を取得し、返却する。
	\item 機器情報の追加・変更・削除を求められた場合\\
		サービスは、DBへ変更を保存する。
	\item ログ一覧を求められた場合\\
		サービスは、DBから機器の状態を取得・整理し、返却する
\end{itemize}

\section{ユーザーの動き？}
ユーザーの動きは以下のとおりである。
\begin{itemize}
\item デバイスを追加するとき
	\begin{enumerate}
		\item ブラウザからサービスにアクセスし、ログインする。
		\item 画面から追加ボタン（＋ボタン）をクリックし、デバイス名、デバイスの説明を入力する。\\
			この際、デバイスIDがすでに決まっているのであれば、それも入力する。
		\item デバイスIDをメモする。（既に決まっているのであれば、特段シなくても良い）
		\item Addボタンを押す
		\item デバイスに対し、エージェントプログラムをインストールし、自動で起動するよう設定する。\\
			その際、エージェントへの引数として、サーバーのIPアドレス、デバイスIDを設定する。
	\end{enumerate}
\item デバイスを削除するとき
	\begin{enumerate}
		\item ブラウザからサービスにアクセスし、ログインする。
		\item 画面から該当のデバイスをクリックし、削除ボタンをクリックする。
		\item 「ほんとに削除するの？」というダイアログが出るので、OKを押し、画面からデバイスが削除されたことを確認する。
	\end{enumerate}
\item 登録されているデバイス情報を変更するとき
	\begin{enumerate}
		\item ブラウザからサービスにアクセスし、ログインする。
		\item 画面から該当のデバイスをクリックし、変更ボタンを押す。
		\item デバイス作成時と同じようなダイアログが表示されるので、デバイス名やデバイス情報を編集する。
		\item OKボタンをクリックし、デバイスの情報が変わったことを確認する。
	\end{enumerate}
\item デバイスの現在の状態を確認するとき
	\begin{enumerate}
		\item ブラウザからサービスにアクセスし、ログインする。
		\item 該当のデバイスを確認する。\\
			緑が稼働している状態、赤が稼働していない若しくは、稼働しているかわからない状態である。
	\end{enumerate}
\item デバイスの過去の状態を確認するとき
	\begin{enumerate}
		\item ブラウザからサービスにアクセスし、ログインする。
		\item Logページボタンを押す。
		\item デバイスのログ一覧が出るので、該当デバイスを探しだし、確認する。
	\end{enumerate}
\end{itemize}









