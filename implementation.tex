\section{機器監視サービスの構成}
%（どのような要素で構成されているのか、また、それぞれの役割は何なのか）
%1.1全体構成（どのような要素で構成され、また、それぞれの役割について簡潔に述べる）
第3章にて述べた要件に基づき、システムを構築した。
システムは、「笠谷くん」というエージェントプログラム、機器状態データベース、機器情報データベース、「かおりちゃん」というエージェントプログラム用インターフェースプログラム、「田頭さん」というWebアプリケーションサーバプログラム、「谷口さん」というWebアプリケーションクライアントプログラムから成り立っている。
\medskip

笠谷くんとは、エージェントプログラムの事で、IoT機器上で動作するプログラムである。
定期的に自身の状態を検知し、状態蓄積システムへ送信する役割を果たす。
定期的かつ自発的に状態を送信することで、ネットワーク環境によらない機器の監視を可能にした。
\medskip

かおりちゃんとは、エージェントプログラム用インターフェースである。
かおりちゃんは、各IoT機器上で動く笠谷くんから送られてきた状態を、時刻と共に機器状態データベースへ書き込む役割を果たすプログラムで、機器監視サーバー上で動作する。
\medskip

機器状態データベースとは、機器の状態を時系列に沿って蓄積するデータベースである。
機器監視サーバー上で動作する。
\medskip

機器情報データベースとは、機器IDや、機器名、ユーザー名を記録するデータベースである。
機器監視サーバー上で動作する。
\medskip

谷口さんとは、ブラウザ上で動作するWebアプリケーションプログラムである。
ユーザーからの入力を受け、ユーザーへ表示する他、田頭さんへ必要な情報を問い合わせる。
\medskip

田頭さんとは、Webアプリケーションサーバーである。
Webページや谷口さんを送信する他、谷口さんからの要求に答え、谷口さんへ現在の機器の状態や、機器名等を返答する。

\medskip

これら各要素が連携することで、機器の監視を容易なものとした。

\subsection{エージェントプログラム}
%（エージェントプログラムとは何なのか）
エージェントプログラムとは、IoT機器上にインストールされるプログラムである。
エージェントプログラムの役割は、自身の状態を検知・記録し、状態蓄積システムへ送信することである。
自発的に状態を報告するため、IoT機器にプライベートアドレスが付与されていても、状態を検知することができる。
また、HTTPを用いるため、間のネットワークにてブロックされることがない。

\subsection{状態蓄積システム}
%（とは何なのか）
状態蓄積システムとは、サーバー上で動作するプログラムである。
各IoT機器から送られてきた状態を時間と共に記録する役割を持つ。
状態の蓄積の為に、データベースを用いている。
次の状態表示システムとデータベースを介し連携している。

\subsection{状態表示システム}
状態表示システムとは、Webアプリケーションである。
機器情報データベース、機器状態データベース、Webサーバーアプリケーション、Webクライアントアプリケーションの4つに分けることができる。
\medskip

機器情報データベースとは、機器名や機器の詳細、機器IDを管理するデータベースである。
機器状態データベースとは、機器の状態を時刻と共に記録するためのデータベースである。
Webサーバーアプリケーションは、URLに基づき機器の現在の状態や機器の過去の状態、Webページ、WebクライアントアプリケーションをWebブラウザに返すものである。
これら３つは、機器監視サーバー上で動作する。
\medskip

Webクライアントアプリケーションとは、ユーザーへインターフェースを提供するものである。
Webサーバーアプリケーションに機器の現在の状態や、機器情報等を問い合わせ、必要に応じてユーザーへ表示する

\section{エージェントプログラムの実装}
エージェントプログラムの役割は、定期的にIoT機器の状態を検知し、IoT機器監視サーバーに送信することである。
どのようなLinux環境でも動作することを考え、Shellスクリプトにて実装した。

\section{状態蓄積システムの実装}
情報蓄積システムの役割は、各IoT機器上で動作するエージェントプログラムから送られてきたIoT機器の状態を時刻と共に記録することである。
api.pyというPythonスクリプトである。FalconというRESTAPIの作成に特化したライブラリを用いて実装した。

\section{機器情報データベース}
機器情報データベースの役割は、機器の名前、機器の詳細説明、機器ID、ログイン用ユーザーIDとパスワードを記録し保持する事である。
機器情報データベースには、次のようなテーブルが用意されている。
\subsection{機器情報テーブル}
機器ID、ユーザーIDをキーとして、機器の名前、機器の詳細説明を記録し保持するテーブルである。
\subsection{ユーザーテーブル}
ユーザーIDをキーとして、ユーザー名とパスワードを記録し保持するテーブルである。
機器情報データベースには、SQLiteを用いた。

\section{機器状態データベース}
機器状態データベースの役割は、機器の状態を時刻と共に記録・保持することである。
機器状態データベースには、Influxdbを用いた。
機器IDをメトリクス名（テーブル名）とし、時刻をキーとして、機器の状態を記録している。

\section{Webサーバーアプリケーション}
Webサーバーアプリケーションの役割は、与えられたHTTPリクエストを元に、各種情報を返却することにある。
Flaskと呼ばれるWebアプリケーションフレームワークを用いた。Pythonを使用している。
URLの設計として次のようになっている。
\begin{description}
	\item[GET /login]\mbox{}\\
		ログインページを返す。
	\item[POST /login]\mbox{}\\
		メールアドレスとパスワードを受け取る。\\
		クッキーからセッションキーを探し、存在すれば既にログインしているとして、/dashboardへのリダイレクトメッセージを返す。
		データベースにメールアドレスとパスワードの組が存在するか確認し、存在した場合、セッションキーを返す。\\
		存在しなかった場合、ログインエラーページを返す。
	\item[GET /logout]\mbox{}\\
		セッションキーを受け取り、該当のセッションを削除する。\\
	\item[GET /dashboard]\mbox{}\\
		ログインチェックをし、機器状態一覧ページを返す。
	\item[GET /devicelog]\mbox{}\\
		ログインチェックをし、過去の機器状態一覧ページを返す。
	\item[GET /api/device/all]\mbox{}\\
		ログインチェックをし、現在の状態、最後にメッセージを受け取った日時、機器ID、機器名、機器詳細のデータを、JSON形式にまとめたものを返す。
	\item[GET /api/deviceID]\mbox{}\\
		ログインチェックをし、ランダムにデバイスIDを生成し、JSON形式にまとめたものを返す。
	\item[POST /api/deviceID]\mbox{}\\
		ログインチェックをし、受け取ったデバイスIDが既に存在するか確認し、その結果をJSON形式にまとめ、返す。
	\item[POST /api/device/\{DeviceID\}]\mbox{}\\
		ログインチェックをし、デバイスIDと受け取ったJSONデータから、デバイスの新規作成・編集をし、結果をJSON形式にまとめ、返す。
	\item[DELETE /api/device/\{DeviceID\}]\mbox{}\\
		ログインチェックをし、該当のデバイスIDを持つデバイスをデータベースから削除する。	
\end{description}

\section{Webクライアントアプリケーション}
Webクライアントアプリケーションの役割は、インタラクティブなUIを提供することである。
Bootstrap,JQueryといったライブラリを用いて作成した。HTML,CSS,Javascriptで書かれている。
Javascriptで定期的に状態を取得し、HTML,CSSにて表示する。




